<script>
document.addEventListener("DOMContentLoaded", () => {

let viewLocked = false;
let neutralOrientation = { alpha: 0, beta: 0, gamma: 0 };
let lastOrientation = null;

let smoothAlpha = 0;
let smoothBeta = 0;
let smoothGamma = 0;
const smoothingFactor = 0.15;

const selectedPosition = {
  leftOfSternum: false,
  thirdIntercostal: false,
  fifthIntercostal: false,
  midClavicular: false,
  midlineXiphoid: false,
  rightOfMidline: false
};

const images = [
  document.getElementById("cardioImage1"),
  document.getElementById("cardioImage2"),
  document.getElementById("cardioImage3"),
  document.getElementById("cardioImage4"),
  document.getElementById("cardioImage5")
];

const viewLabel = document.getElementById("viewLabel");

function showView(imageElement, labelText) {
  if (viewLocked) return;

  viewLocked = true;

  images.forEach(img => img.style.display = "none");

  imageElement.style.display = "block";
  viewLabel.textContent = labelText;
  viewLabel.style.display = "block";

  setTimeout(() => {
    viewLocked = false;
  }, 1000);
}

function toggleRegion(id) {
  const region = document.getElementById(id);
  region.addEventListener("click", () => {
    selectedPosition[id] = !selectedPosition[id];
    region.classList.toggle("highlight");
  });
}

["leftOfSternum", "thirdIntercostal", "fifthIntercostal", "midClavicular", "midlineXiphoid", "rightOfMidline"]
  .forEach(toggleRegion);

document.getElementById("setNeutralButton").addEventListener("click", () => {
  if (lastOrientation) {
    neutralOrientation.alpha = lastOrientation.alpha || 0;
    neutralOrientation.beta = lastOrientation.beta || 0;
    neutralOrientation.gamma = lastOrientation.gamma || 0;
    alert("Neutral orientation set!");
  }
});

function handleOrientation(event) {
  if (viewLocked) return;

  lastOrientation = event;

  const alpha = (event.alpha || 0) - neutralOrientation.alpha;
  const beta  = (event.beta  || 0) - neutralOrientation.beta;
  const gamma = (event.gamma || 0) - neutralOrientation.gamma;

  smoothAlpha += (alpha - smoothAlpha) * smoothingFactor;
  smoothBeta  += (beta  - smoothBeta)  * smoothingFactor;
  smoothGamma += (gamma - smoothGamma) * smoothingFactor;

  document.getElementById("alpha").textContent = alpha.toFixed(1);
  document.getElementById("beta").textContent  = beta.toFixed(1);
  document.getElementById("gamma").textContent = gamma.toFixed(1);

  if (selectedPosition.leftOfSternum && selectedPosition.thirdIntercostal &&
      smoothBeta >= 70 && smoothBeta <= 110 &&
      (smoothAlpha >= 300 || smoothAlpha <= 20)) {

    showView(images[0], "Parasternal Long Axis (PLAX)");
  }

  else if (selectedPosition.leftOfSternum && selectedPosition.thirdIntercostal &&
           smoothBeta >= 75 && smoothBeta <= 100 &&
           (smoothAlpha >= 10 && smoothAlpha <= 45)) {

    showView(images[1], "Parasternal Short Axis (PSAX)");
  }

  else if (selectedPosition.fifthIntercostal && selectedPosition.midClavicular &&
           smoothBeta >= 75 && smoothBeta <= 110) {

    showView(images[2], "Apical 4 Chamber (A4C)");
  }

  else if (selectedPosition.midlineXiphoid &&
           smoothBeta >= 75 && smoothBeta <= 100 &&
           (smoothAlpha >= 190 && smoothAlpha <= 220)) {

    showView(images[3], "Subcostal 4 Chamber (SC4C)");
  }

  else if (selectedPosition.rightOfMidline &&
           smoothBeta >= 75 && smoothBeta <= 100 &&
           (smoothAlpha >= 350 || smoothAlpha <= 10)) {

    showView(images[4], "IVC");
  }
}

function enableOrientationTracking() {
  const dataDiv = document.getElementById("orientationData");
  const enableButton = document.getElementById("enableButton");

  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {

    DeviceOrientationEvent.requestPermission().then(permissionState => {
      if (permissionState === 'granted') {
        window.addEventListener('deviceorientation', handleOrientation);
        dataDiv.style.display = 'block';
        enableButton.style.display = 'none';
      }
    }).catch(console.error);

  } else {
    window.addEventListener('deviceorientation', handleOrientation);
    dataDiv.style.display = 'block';
    enableButton.style.display = 'none';
  }
}

document.getElementById("enableButton")
  .addEventListener("click", enableOrientationTracking);

});
</script>
